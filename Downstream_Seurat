## Load Seurat and the epithelial file. ggplot2 will be used for some visualization, as well.
library(ggplot2)
library(Seurat)
load('ovy.epi')

### AGING COMPARISONS

## Calculate proportional differences between clusters in aging. And find log odds. 
# Set the identities as 'NamedTypes', as these are the defined clusters.
Idents(ovy.epi) <- 'NamedTypes'
# Create a dataframe with proportions of each cluster in both age groups, and calculate log oddds.
cpt <- as.data.frame.matrix(prop.table(table(Idents(ovy.epi), ovy.epi$Age), margin = 2))
cpt$Odds <- cpt$Aged/cpt$Young
cpt$LogOdds <- log2(cpt$Odds)

## Find differentially expressed genes in each cluster between the age groups. 
# Calculate fold changes for ALL genes in each cluster.
B1ovy <- FindMarkers(ovy.epi, subset.ident = 'Basal-1',group.by = 'Age', ident.1 = 'Old', logfc.threshold = 0, min.pct = 0, test.use = 'MAST')
B2ovy <- FindMarkers(ovy.epi, subset.ident = 'Basal-2',group.by = 'Age', ident.1 = 'Old', logfc.threshold = 0, min.pct = 0, test.use = 'MAST')
B3ovy <- FindMarkers(ovy.epi, subset.ident = 'Basal-3',group.by = 'Age', ident.1 = 'Old', logfc.threshold = 0, min.pct = 0, test.use = 'MAST')
B4ovy <- FindMarkers(ovy.epi, subset.ident = 'Basal-4',group.by = 'Age', ident.1 = 'Old', logfc.threshold = 0, min.pct = 0, test.use = 'MAST')
B5ovy <- FindMarkers(ovy.epi, subset.ident = 'Basal-5',group.by = 'Age', ident.1 = 'Old', logfc.threshold = 0, min.pct = 0, test.use = 'MAST')
Iovy <- FindMarkers(ovy.epi, subset.ident = 'Suprabasal',group.by = 'Age', ident.1 = 'Old', logfc.threshold = 0, min.pct = 0, test.use = 'MAST')
D1ovy <- FindMarkers(ovy.epi, subset.ident = 'Superficial-1',group.by = 'Age', ident.1 = 'Old', logfc.threshold = 0, min.pct = 0, test.use = 'MAST')
D2ovy <- FindMarkers(ovy.epi, subset.ident = 'Superficial-2',group.by = 'Age', ident.1 = 'Old', logfc.threshold = 0, min.pct = 0, test.use = 'MAST')
# Create a master dataframe that combines all the fold changes in each cluster.
B1ovy$Cluster <- rep('Basal-1',length(rownames(B1ovy)))
B2ovy$Cluster <- rep('Basal-2',length(rownames(B2ovy)))
B3ovy$Cluster <- rep('Basal-3',length(rownames(B3ovy)))
B4ovy$Cluster <- rep('Basal-4',length(rownames(B4ovy)))
B5ovy$Cluster <- rep('Basal-5',length(rownames(B5ovy)))
Iovy$Cluster <- rep('Suprabasal',length(rownames(Iovy)))
D1ovy$Cluster <- rep('Superficial-1',length(rownames(D1ovy)))
D2ovy$Cluster <- rep('Superficial-2',length(rownames(D2ovy)))
# Assign "significant" or "non-significant" for each fold change given adjusted p-value.
jitdf <- as.data.frame(rbind(B1ovy,B2ovy,B3ovy,B4ovy,B5ovy,Iovy,D1ovy,D2ovy))
sig <- c()
for (x in jitdf$p_val_adj){if (x >= 0.05){sig <- append(sig,'Non-Significant')} else {sig <- append(sig,'Significant')}}
# Add significance classifications to the dataframe.
jitdf$Significance <- sig
# Relevel the clusters, just in case. 
jitdf$Cluster <- factor(jitdf$Cluster, levels = c('Basal-1','Basal-2','Basal-3','Basal-4','Basal-5','Intermediate','Differentiating-1','Differentiating-2'))
# Plot.
ggplot(jitdf, aes(x=Cluster, y=avg_logFC, color = Significance)) + geom_jitter() + theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + ylab('Average Natural log FC') + scale_color_manual(values=c('blue','red'))

### EXPRESSION OF CANONICAL MARKERS

## Visualize canonical basal markers.
basalmarkers <- c('Mki67','Cd34','Nt5e', 'Itgb1','Itgb4','Itga6','Trp63','Sox2', 'Krt15','Krt14','Krt5')
DotPlot(ovy.epi, features = basalmarkers, group.by = 'NamedTypes', assay = 'RNA', cols = c('blue','red'))+ RotatedAxis()

## Visualize canonical superficial markers.
diffmarkers <- c('Ivl','Flg','Fst','Lor','Krt4','Krt13','Krtdap')
DotPlot(ovy.epi, features = diffmarkers, group.by = 'NamedTypes', assay = 'RNA', cols = c('blue','red'))+ RotatedAxis()

### Find the most cluster-exclusive markers. 
## These markers will be ranked by how lowly they're expressed in clusters other than the one in question.



